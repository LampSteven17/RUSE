---
# Ansible Playbook: provision-vms.yaml
# Step 1: Provision OpenStack VMs for SUP deployment
#
# Architecture:
#   Ansible → SSH → axes (OpenStack CLI) → OpenStack API
#                                        → SSH → new VMs
#
# Usage:
#   ansible-playbook -i hosts.ini provision-vms.yaml
#
# Output:
#   Creates inventory.ini file for use by install-sups.yaml

- name: Provision VMs - babys-first-sups
  hosts: openstack_controller
  gather_facts: false

  vars:
    # OpenStack RC file on axes
    os_rc_file: "~/vxn3kr-bot-rc"
    os_image: "noble-amd64"
    os_network: "ext_net"
    os_keypair: "bot-desktop"
    os_security_group: "default"

    # SSH config for ProxyJump (on Ansible control node)
    ssh_config_file: "/home/ubuntu/.ssh/config"
    jump_host: "axes"

    # Inventory file output path (on Ansible control node)
    inventory_file: "{{ playbook_dir }}/inventory.ini"

    # Available flavor capacity (adjust based on your quota)
    flavor_capacity:
      rtx2080ti-1gpu.14vcpu.28g: 5
      rtx2080ti-A-1gpu.14vcpu.28g: 3
      v100-1gpu.14vcpu.28g: 4
      v1.14vcpu.28g: 10

    # SUPs to deploy
    deployments:
      - behavior: S1.llama
        flavor: rtx2080ti-1gpu.14vcpu.28g
        count: 1

      - behavior: B1.llama
        flavor: v100-1gpu.14vcpu.28g
        count: 2

      - behavior: M1
        flavor: rtx2080ti-A-1gpu.14vcpu.28g
        count: 1

      - behavior: M1
        flavor: v1.14vcpu.28g
        count: 1

  tasks:
    - name: Expand deployments to VM list
      set_fact:
        vm_list: >-
          {%- set vms = [] -%}
          {%- set behavior_counts = {} -%}
          {%- for dep in deployments -%}
            {%- for i in range(dep.count) -%}
              {%- set idx = behavior_counts.get(dep.behavior, 0) -%}
              {%- set _ = behavior_counts.update({dep.behavior: idx + 1}) -%}
              {%- set _ = vms.append({'behavior': dep.behavior, 'flavor': dep.flavor, 'index': idx}) -%}
            {%- endfor -%}
          {%- endfor -%}
          {{ vms }}

    - name: Display VMs to be created
      debug:
        msg: "Will create {{ vm_list | length }} VMs: {{ vm_list | map(attribute='behavior') | list }}"

    - name: Create OpenStack VMs
      shell: |
        source {{ os_rc_file }}
        # Check if VM already exists
        if openstack server show "sup-{{ item.behavior | replace('.', '-') }}-{{ item.index }}" &>/dev/null; then
          echo "VM already exists"
          openstack server show "sup-{{ item.behavior | replace('.', '-') }}-{{ item.index }}" -f json
        else
          openstack server create \
            --flavor "{{ item.flavor }}" \
            --image "{{ os_image }}" \
            --boot-from-volume 200 \
            --network "{{ os_network }}" \
            --key-name "{{ os_keypair }}" \
            --security-group "{{ os_security_group }}" \
            --wait \
            -f json \
            "sup-{{ item.behavior | replace('.', '-') }}-{{ item.index }}"
        fi
      args:
        executable: /bin/bash
      loop: "{{ vm_list }}"
      loop_control:
        label: "sup-{{ item.behavior }}-{{ item.index }}"
      register: created_vms

    - name: Get VM IPs
      shell: |
        source {{ os_rc_file }}
        openstack server show "sup-{{ item.behavior | replace('.', '-') }}-{{ item.index }}" -f value -c addresses | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+'
      args:
        executable: /bin/bash
      loop: "{{ vm_list }}"
      loop_control:
        label: "sup-{{ item.behavior }}-{{ item.index }}"
      register: vm_ips

    - name: Build inventory data
      set_fact:
        inventory_entries: >-
          {%- set entries = [] -%}
          {%- for result in vm_ips.results -%}
            {%- set vm = vm_list[loop.index0] -%}
            {%- set entry = {
              'ip': result.stdout,
              'behavior': vm.behavior,
              'name': 'sup-' + vm.behavior | replace('.', '-') + '-' + (vm.index | string)
            } -%}
            {%- set _ = entries.append(entry) -%}
          {%- endfor -%}
          {{ entries }}

    - name: Display created VMs
      debug:
        msg: |
          Created {{ inventory_entries | length }} VMs:
          {% for entry in inventory_entries %}
            - {{ entry.name }}: {{ entry.ip }} ({{ entry.behavior }})
          {% endfor %}

    - name: Generate inventory file on control node
      delegate_to: localhost
      copy:
        content: |
          # Auto-generated inventory for babys-first-sups
          # Generated: {{ lookup('pipe', 'date -Iseconds') }}
          # Access: Via ProxyJump through {{ jump_host }}

          [sup_hosts]
          {% for entry in inventory_entries %}
          {{ entry.name }} ansible_host={{ entry.ip }} sup_behavior={{ entry.behavior }}
          {% endfor %}

          [sup_hosts:vars]
          ansible_user=ubuntu
          ansible_python_interpreter=/usr/bin/python3
          ansible_ssh_common_args=-F {{ ssh_config_file }} -o ProxyJump={{ jump_host }} -o StrictHostKeyChecking=no
        dest: "{{ inventory_file }}"

    - name: Display inventory file location
      debug:
        msg: "Inventory written to: {{ inventory_file }}"

    - name: Test SSH connectivity to VMs (via axes)
      delegate_to: localhost
      shell: |
        ssh -F {{ ssh_config_file }} -o ProxyJump={{ jump_host }} -o StrictHostKeyChecking=no -o ConnectTimeout=30 ubuntu@{{ item.ip }} 'echo SSH OK'
      loop: "{{ inventory_entries }}"
      loop_control:
        label: "{{ item.name }} ({{ item.ip }})"
      register: ssh_test
      retries: 10
      delay: 30
      until: ssh_test.rc == 0

    - name: Write SSH config snippet to file
      delegate_to: localhost
      copy:
        content: |
          ############# SUP VMs #############
          # Add this to your ~/.ssh/config
          # Requires ProxyJump through axes

          Host sup-*
              User ubuntu
              PreferredAuthentications publickey
              IdentityFile ~/.ssh/id_rsa
              ProxyJump axes
              StrictHostKeyChecking no
              ServerAliveInterval 120

          {% for entry in inventory_entries %}
          Host {{ entry.name }}
              HostName {{ entry.ip }}

          {% endfor %}
          #####################################
        dest: "{{ playbook_dir }}/ssh_config_snippet.txt"

    - name: Display SSH config location
      debug:
        msg: "SSH config saved to: {{ playbook_dir }}/ssh_config_snippet.txt"

    - name: Print SSH config (copy-pasteable)
      delegate_to: localhost
      command: cat "{{ playbook_dir }}/ssh_config_snippet.txt"
      register: ssh_out
      changed_when: false

    - name: SSH Config Output
      pause:
        seconds: 1
        prompt: |

          ═══════════════════════════════════════════════════════════════
            SSH CONFIG - Copy and paste into ~/.ssh/config
          ═══════════════════════════════════════════════════════════════
          {{ ssh_out.stdout }}
          ═══════════════════════════════════════════════════════════════
            Saved to: {{ playbook_dir }}/ssh_config_snippet.txt
          ═══════════════════════════════════════════════════════════════
