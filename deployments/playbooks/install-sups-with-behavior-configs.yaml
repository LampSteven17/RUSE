---
# Ansible Playbook: install-sups-with-behavior-configs.yaml
# Step 2b: Install SUPs then distribute matching PHASE behavioral configs.
#
# This is the behavior-configs variant of install-sups.yaml. It runs the
# standard install, then distributes behavioral configs matched to each
# SUP's baseline version:
#
#   Version 0/1 (baseline) → configs from exp3_axes-fall24 (default)
#   Version 2 (iteration 2) → configs from behavior_source
#   Version 3 (iteration 3) → configs from behavior_source
#   Version 4 (iteration 4) → configs from behavior_source
#
# Prerequisites:
#   - PHASE behavioral configs generated for all three datasets
#   - VMs provisioned (inventory.ini exists)
#
# Usage:
#   ansible-playbook -i ../sups2-csdept-sum24/runs/0219/inventory.ini \
#       install-sups-with-behavior-configs.yaml \
#       -e deployment_dir=../sups2-csdept-sum24

# ── Phase 1: Standard SUP install (identical to install-sups.yaml) ──────────
- name: Install SUPs
  hosts: sup_hosts
  become: yes
  serial: 10
  strategy: free
  vars:
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ServerAliveInterval=30 -o ServerAliveCountMax=60 -o ConnectTimeout=30'
    ansible_ssh_retries: 5
    deployment_dir: "{{ playbook_dir }}"
    config_file: "{{ deployment_dir }}/config.yaml"
    ruse_repo: "https://github.com/LampSteven17/RUSE.git"
    ruse_branch: "main"
    ruse_path: "/opt/ruse"

  pre_tasks:
    - name: Wait for SSH to become available
      wait_for_connection:
        delay: 5
        timeout: 300
      retries: 3
      delay: 10

    - name: Load deployment configuration
      include_vars:
        file: "{{ config_file }}"
      delegate_to: localhost
      run_once: true

  tasks:
    - name: Display target configuration
      debug:
        msg: "Installing {{ sup_behavior }} on {{ inventory_hostname }} ({{ ansible_host }})"

    - name: Wait for cloud-init to complete
      command: cloud-init status --wait
      changed_when: false
      timeout: 300

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install prerequisites
      apt:
        name:
          - git
          - curl
          - wget
        state: present

    - name: Clone RUSE repo
      git:
        repo: "{{ ruse_repo }}"
        dest: "{{ ruse_path }}"
        version: "{{ ruse_branch }}"
        force: yes

    - name: Make INSTALL_SUP.sh executable
      file:
        path: "{{ ruse_path }}/INSTALL_SUP.sh"
        mode: '0755'

    - name: Run INSTALL_SUP.sh Stage 1 (system deps, drivers)
      shell: |
        cd {{ ruse_path }}
        ./INSTALL_SUP.sh --{{ sup_behavior }} --stage=1
      args:
        executable: /bin/bash
      async: 1800
      poll: 30
      register: stage1_result
      failed_when: stage1_result.rc not in [0, 100]

    - name: Reboot if NVIDIA drivers were installed (exit code 100)
      reboot:
        reboot_timeout: 600
        msg: "Rebooting for NVIDIA driver to load"
      when: stage1_result.rc == 100

    - name: Track Stage 1 outcome
      set_fact:
        install_stage1: "OK"
        install_reboot: "{{ 'YES' if stage1_result.rc == 100 else 'skip' }}"

    - name: Run INSTALL_SUP.sh Stage 2 (ollama, python, services)
      shell: |
        cd {{ ruse_path }}
        ./INSTALL_SUP.sh --{{ sup_behavior }} --stage=2
      args:
        executable: /bin/bash
      async: 1800
      poll: 30
      register: stage2_result

    - name: Track Stage 2 outcome
      set_fact:
        install_stage2: "OK"

    - name: Display install result
      debug:
        msg: "SUP {{ sup_behavior }} installed successfully on {{ inventory_hostname }}"
      when: stage2_result.rc == 0

    - name: Check SUP service status
      shell: systemctl is-active $(systemctl list-units --type=service | grep -E '(mchp|smol|bu)' | awk '{print $1}' | head -1) || true
      register: service_status
      changed_when: false

    - name: Track service status
      set_fact:
        install_service: "{{ service_status.stdout | default('none') | trim }}"


# ── Phase 2: Distribute behavioral configs matched to baseline ──────────────
- name: Distribute PHASE behavioral configs (baseline-matched)
  hosts: sup_hosts
  become: yes
  strategy: free
  vars:
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ServerAliveInterval=30 -o ConnectTimeout=30'
    deployment_dir: "{{ playbook_dir }}"
    config_file: "{{ deployment_dir }}/config.yaml"
    ruse_path: "/opt/ruse"

  pre_tasks:
    - name: Load deployment configuration (for behavior_source)
      include_vars:
        file: "{{ config_file }}"
      delegate_to: localhost
      run_once: true

  tasks:
    # Skip controls — they don't get behavioral configs
    - name: Skip control configs (C0, M0)
      meta: end_host
      when: sup_behavior in ['C0', 'M0']

    # Derive behavior directory from config key: M3 → M, B3.gemma → B.gemma, B0C.gemma → B.gemma
    - name: Derive behavior directory from config key
      set_fact:
        behavior_dir: "{{ sup_behavior | regex_replace('^([A-Z])\\d+[A-Z]*(.*)$', '\\1\\2') }}"

    # Derive baseline config key: M2 → M1, B2C.gemma → B0C.gemma, S3.llama → S0.llama
    - name: Derive baseline version (M=1, B/S=0)
      set_fact:
        baseline_version: "{{ '1' if sup_behavior[0] == 'M' else '0' }}"

    - name: Derive baseline config key (e.g. B2C.gemma → B0C.gemma)
      set_fact:
        baseline_config: "{{ sup_behavior | regex_replace('^([A-Z])\\d+', '\\1' ~ baseline_version) }}"

    # Resolve the source directory path (expand ~ on control node)
    - name: Resolve behavior source
      set_fact:
        resolved_behavior_source: "{{ behavior_source | replace('~', lookup('env', 'HOME')) }}"

    - name: Resolve config-specific source directory
      set_fact:
        config_source_dir: "{{ resolved_behavior_source }}/{{ behavior_dir }}/{{ baseline_config }}"

    - name: Display behavior config mapping
      debug:
        msg: "{{ sup_behavior }} → {{ baseline_config }} → {{ config_source_dir }}"

    # Verify the config source directory exists
    - name: Check config source directory exists
      stat:
        path: "{{ config_source_dir }}"
      delegate_to: localhost
      register: bc_source_dir

    - name: Warn if config source not found
      debug:
        msg: "WARNING: Config source not found: {{ config_source_dir }} — skipping behavioral configs for {{ sup_behavior }}"
      when: not bc_source_dir.stat.exists

    - name: Track behavior configs skipped
      set_fact:
        install_behavior_configs: "SKIP"
      when: not bc_source_dir.stat.exists

    # Deploy behavioral configs from source directory
    - name: Deploy behavioral configs
      when: bc_source_dir.stat.exists
      block:
        - name: Ensure behavioral_configurations directory exists on VM
          file:
            path: "{{ ruse_path }}/deployed_sups/{{ sup_behavior }}/behavioral_configurations/"
            state: directory
            mode: '0755'

        - name: Find behavior config files
          find:
            paths: "{{ config_source_dir }}"
            patterns: "{{ behavior_configs | default(['*.json']) }}"
            excludes: "recommendations.json"
          delegate_to: localhost
          register: behavior_config_files

        - name: Copy behavior configs to SUP
          copy:
            src: "{{ item.path }}"
            dest: "{{ ruse_path }}/deployed_sups/{{ sup_behavior }}/behavioral_configurations/{{ item.path | basename }}"
            mode: '0644'
          loop: "{{ behavior_config_files.files }}"
          loop_control:
            label: "{{ item.path | basename }}"

        - name: Report deployment
          debug:
            msg: "{{ sup_behavior }} ← {{ behavior_dir }}/{{ baseline_config }}/ ({{ behavior_config_files.files | length }} configs)"

        - name: Track behavior configs deployment
          set_fact:
            install_behavior_configs: "{{ behavior_config_files.files | length }} files"


# ── Summary ─────────────────────────────────────────────────────────────────
- name: Deployment Summary
  hosts: localhost
  gather_facts: false
  vars:
    deployment_dir: "{{ playbook_dir }}"
    _output_dir: "{{ run_dir | default(deployment_dir) }}"
  tasks:
    - name: Load deployment configuration
      include_vars:
        file: "{{ deployment_dir }}/config.yaml"

    - name: Display deployment matrix
      vars:
        matrix_hosts: "{{ groups['sup_hosts'] | sort }}"
      pause:
        seconds: 0
        prompt: |

          ═══════════════════════════════════════════════════════════════════════════════════════
            DEPLOYMENT MATRIX  ({{ matrix_hosts | length }} hosts)
          ═══════════════════════════════════════════════════════════════════════════════════════
            {{ "%-24s %-14s %-8s %-8s %-8s %-10s %s" | format("HOST", "CONFIG", "STAGE1", "REBOOT", "STAGE2", "SERVICE", "BHVR") }}
            {{ "─" * 84 }}
          {% for host in matrix_hosts %}
          {% set hv = hostvars[host] %}
          {% set config = hv.sup_behavior | default('?') %}
          {% set is_ctl = config in ['C0', 'M0'] %}
          {% set s1 = hv.install_stage1 | default('FAIL') %}
          {% set rb = hv.install_reboot | default('--') %}
          {% set s2 = hv.install_stage2 | default('FAIL') %}
          {% set svc = 'n/a' if is_ctl else (hv.install_service | default('FAIL')) %}
          {% set bc = 'n/a' if is_ctl else (hv.install_behavior_configs | default('FAIL')) %}
            {{ "%-24s %-14s %-8s %-8s %-8s %-10s %s" | format(host, config, s1, rb, s2, svc, bc) }}
          {% endfor %}
            {{ "─" * 84 }}
          {% set ns = namespace(ok=0, fail=0) %}
          {% for host in matrix_hosts %}
          {% if hostvars[host].install_stage2 | default('') == 'OK' %}
          {% set ns.ok = ns.ok + 1 %}
          {% else %}
          {% set ns.fail = ns.fail + 1 %}
          {% endif %}
          {% endfor %}
            RESULT: {{ ns.ok }} installed / {{ ns.fail }} failed
          ═══════════════════════════════════════════════════════════════════════════════════════

          STAGE1  = System deps + GPU drivers (INSTALL_SUP.sh --stage=1)
          REBOOT  = NVIDIA driver reload (YES = rebooted, skip = not needed)
          STAGE2  = Ollama + Python + services (INSTALL_SUP.sh --stage=2)
          SERVICE = systemd service status after install
          BHVR    = PHASE behavioral configs deployed (file count)

    - name: Check for SSH config file
      stat:
        path: "{{ _output_dir }}/ssh_config_snippet.txt"
      register: ssh_config_file

    - name: Read SSH config
      command: cat "{{ _output_dir }}/ssh_config_snippet.txt"
      register: ssh_config_content
      when: ssh_config_file.stat.exists
      changed_when: false

    - name: Display SSH Config
      pause:
        seconds: 0
        prompt: |

          ═══════════════════════════════════════════════════════════════
            SSH CONFIG - Copy and paste into ~/.ssh/config
          ═══════════════════════════════════════════════════════════════
          {{ ssh_config_content.stdout }}
          ═══════════════════════════════════════════════════════════════
            Saved to: {{ _output_dir }}/ssh_config_snippet.txt
          ═══════════════════════════════════════════════════════════════
      when: ssh_config_file.stat.exists
