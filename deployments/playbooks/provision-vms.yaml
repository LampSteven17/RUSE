---
# Ansible Playbook: provision-vms.yaml (Shared)
# Step 1: Provision OpenStack VMs for SUP deployment
#
# Architecture:
#   Ansible → SSH → axes (OpenStack CLI) → OpenStack API
#                                        → SSH → new VMs
#
# Usage:
#   ansible-playbook -i ../exp-1/hosts.ini provision-vms.yaml -e deployment_dir=../exp-1
#
# Output:
#   Creates inventory.ini file for use by install-sups.yaml

- name: Provision VMs
  hosts: openstack_controller
  gather_facts: false

  vars:
    # Default paths (can be overridden via -e)
    deployment_dir: "{{ playbook_dir }}"
    config_file: "{{ deployment_dir }}/config.yaml"

    # OpenStack defaults (can be overridden in config.yaml)
    os_rc_file: "~/vxn3kr-bot-rc"
    os_image: "noble-amd64"
    os_network: "ext_net"
    os_keypair: "bot-desktop"
    os_security_group: "default"

    # SSH config for ProxyJump (on Ansible control node)
    ssh_config_file: "/home/ubuntu/.ssh/config"
    jump_host: "axes"

  pre_tasks:
    - name: Load deployment configuration
      include_vars:
        file: "{{ config_file }}"

    - name: Set inventory file path
      set_fact:
        inventory_file: "{{ deployment_dir }}/inventory.ini"

    - name: Display deployment info
      pause:
        seconds: 0
        prompt: |

          ═══════════════════════════════════════════════════════════════
            Deployment: {{ deployment_name }}
            Config: {{ config_file }}
          ═══════════════════════════════════════════════════════════════

  tasks:
    # ═══════════════════════════════════════════════════════════════════
    # CAPACITY VALIDATION
    # ═══════════════════════════════════════════════════════════════════
    - name: Calculate flavor usage from deployments
      set_fact:
        flavor_usage: >-
          {%- set usage = {} -%}
          {%- for dep in deployments -%}
            {%- set current = usage.get(dep.flavor, 0) -%}
            {%- set _ = usage.update({dep.flavor: current + dep.count}) -%}
          {%- endfor -%}
          {{ usage }}

    - name: Validate GPU capacity
      set_fact:
        capacity_report: >-
          {%- set report = [] -%}
          {%- set has_shortage = false -%}
          {%- for flavor, requested in flavor_usage.items() -%}
            {%- set available = flavor_capacity.get(flavor, 0) -%}
            {%- set remaining = available - requested -%}
            {%- if remaining < 0 -%}
              {%- set status = 'SHORTAGE' -%}
              {%- set has_shortage = true -%}
            {%- elif remaining == 0 -%}
              {%- set status = 'FULL' -%}
            {%- else -%}
              {%- set status = 'OK' -%}
            {%- endif -%}
            {%- set _ = report.append({
              'flavor': flavor,
              'requested': requested,
              'available': available,
              'remaining': remaining,
              'status': status
            }) -%}
          {%- endfor -%}
          {{ report }}

    - name: Display GPU Capacity Report
      pause:
        seconds: 0
        prompt: |

          ╔════════════════════════════════════════════════════════════════════════╗
          ║                        GPU CAPACITY REPORT                             ║
          ╠══════════════════════════════════════╦═══════╦══════════╦══════════════╣
          ║ Flavor                               ║ Used  ║ Status   ║ Remaining    ║
          ╠══════════════════════════════════════╬═══════╬══════════╬══════════════╣
          {% for item in capacity_report %}
          ║ {{ '%-36s' | format(item.flavor) }} ║ {{ '%2d' | format(item.requested) }}/{{ '%-2d' | format(item.available) }} ║ {{ '%-8s' | format(item.status) }} ║ {{ '%+3d' | format(item.remaining) }} left     ║
          {% endfor %}
          ╠══════════════════════════════════════╩═══════╩══════════╩══════════════╣
          ║ OK=capacity available  FULL=at limit  SHORTAGE=over capacity           ║
          ╚════════════════════════════════════════════════════════════════════════╝

    - name: Check for GPU shortages
      fail:
        msg: |

          ╔════════════════════════════════════════════════════════════════════════╗
          ║                      GPU CAPACITY EXCEEDED                             ║
          ╠════════════════════════════════════════════════════════════════════════╣
          {% for item in capacity_report %}
          {% if item.status == 'SHORTAGE' %}
          ║ SHORTAGE: {{ '%-60s' | format(item.flavor) }} ║
          ║   Requested: {{ '%2d' | format(item.requested) }}  Available: {{ '%2d' | format(item.available) }}  Over by: {{ '%-25d' | format(item.remaining | abs) }} ║
          {% endif %}
          {% endfor %}
          ╠════════════════════════════════════════════════════════════════════════╣
          ║ Please reduce deployment counts or add more GPU capacity               ║
          ╚════════════════════════════════════════════════════════════════════════╝
      when: capacity_report | selectattr('status', 'equalto', 'SHORTAGE') | list | length > 0

    # ═══════════════════════════════════════════════════════════════════
    # VM CREATION
    # ═══════════════════════════════════════════════════════════════════
    - name: Expand deployments to VM list
      set_fact:
        vm_list: >-
          {%- set vms = [] -%}
          {%- set behavior_counts = {} -%}
          {%- for dep in deployments -%}
            {%- for i in range(dep.count) -%}
              {%- set idx = behavior_counts.get(dep.behavior, 0) -%}
              {%- set _ = behavior_counts.update({dep.behavior: idx + 1}) -%}
              {%- set _ = vms.append({'behavior': dep.behavior, 'flavor': dep.flavor, 'index': idx}) -%}
            {%- endfor -%}
          {%- endfor -%}
          {{ vms }}

    - name: Display VMs to be created
      pause:
        seconds: 0
        prompt: |

          ═══════════════════════════════════════════════════════════════
          Will create {{ vm_list | length }} VMs for {{ deployment_name }}:
          ═══════════════════════════════════════════════════════════════
          {% for vm in vm_list %}
            - sup-{{ vm.behavior | replace('.', '-') }}-{{ vm.index }} ({{ vm.flavor | regex_replace('-1gpu.*', '') }})
          {% endfor %}

    - name: Create OpenStack VMs
      shell: |
        source {{ os_rc_file }}
        # Check if VM already exists
        if openstack server show "sup-{{ item.behavior | replace('.', '-') }}-{{ item.index }}" &>/dev/null; then
          echo "VM already exists"
          openstack server show "sup-{{ item.behavior | replace('.', '-') }}-{{ item.index }}" -f json
        else
          openstack server create \
            --flavor "{{ item.flavor }}" \
            --image "{{ os_image }}" \
            --boot-from-volume 200 \
            --network "{{ os_network }}" \
            --key-name "{{ os_keypair }}" \
            --security-group "{{ os_security_group }}" \
            --wait \
            -f json \
            "sup-{{ item.behavior | replace('.', '-') }}-{{ item.index }}"
        fi
      args:
        executable: /bin/bash
      loop: "{{ vm_list }}"
      loop_control:
        label: "sup-{{ item.behavior }}-{{ item.index }}"
      register: created_vms

    - name: Get VM IPs
      shell: |
        source {{ os_rc_file }}
        openstack server show "sup-{{ item.behavior | replace('.', '-') }}-{{ item.index }}" -f value -c addresses | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+'
      args:
        executable: /bin/bash
      loop: "{{ vm_list }}"
      loop_control:
        label: "sup-{{ item.behavior }}-{{ item.index }}"
      register: vm_ips

    - name: Build inventory data
      set_fact:
        inventory_entries: >-
          {%- set entries = [] -%}
          {%- for result in vm_ips.results -%}
            {%- set vm = vm_list[loop.index0] -%}
            {%- set entry = {
              'ip': result.stdout,
              'behavior': vm.behavior,
              'flavor': vm.flavor,
              'name': 'sup-' + vm.behavior | replace('.', '-') + '-' + (vm.index | string)
            } -%}
            {%- set _ = entries.append(entry) -%}
          {%- endfor -%}
          {{ entries }}

    - name: Display created VMs
      pause:
        seconds: 0
        prompt: |

          ═══════════════════════════════════════════════════════════════
          Created {{ inventory_entries | length }} VMs:
          ═══════════════════════════════════════════════════════════════
          {% for entry in inventory_entries %}
            - {{ entry.name }}: {{ entry.ip }} ({{ entry.behavior }})
          {% endfor %}

    - name: Build deployment summary data
      set_fact:
        v100_vms: "{{ inventory_entries | selectattr('flavor', 'equalto', 'v100-1gpu.14vcpu.28g') | list }}"
        rtx_a_vms: "{{ inventory_entries | selectattr('flavor', 'equalto', 'rtx2080ti-A-1gpu.14vcpu.28g') | list }}"
        rtx_vms: "{{ inventory_entries | selectattr('flavor', 'equalto', 'rtx2080ti-1gpu.14vcpu.28g') | list }}"
        nogpu_vms: "{{ inventory_entries | selectattr('flavor', 'equalto', 'v1.14vcpu.28g') | list }}"

    - name: Display Deployment Summary
      pause:
        seconds: 1
        prompt: |

          ╔════════════════════════════════════════════════════════════════════════════════╗
          ║                    {{ '%-52s' | format(deployment_name | upper + ' DEPLOYMENT SUMMARY') }} ║
          ╠════════════════════════════════════════════════════════════════════════════════╣
          ║                                                                                ║
          ║  HARDWARE ALLOCATION                                                           ║
          ║  ┌───────────────────────────────────┬───────────┬───────────┬───────────┐    ║
          ║  │ Flavor                            │ Available │ Assigned  │ Remaining │    ║
          ║  ├───────────────────────────────────┼───────────┼───────────┼───────────┤    ║
          ║  │ v100-1gpu.14vcpu.28g              │ {{ '%9d' | format(flavor_capacity['v100-1gpu.14vcpu.28g'] | default(0)) }} │ {{ '%9d' | format(v100_vms | length) }} │ {{ '%9d' | format((flavor_capacity['v100-1gpu.14vcpu.28g'] | default(0)) - (v100_vms | length)) }} │    ║
          ║  │ rtx2080ti-A-1gpu.14vcpu.28g       │ {{ '%9d' | format(flavor_capacity['rtx2080ti-A-1gpu.14vcpu.28g'] | default(0)) }} │ {{ '%9d' | format(rtx_a_vms | length) }} │ {{ '%9d' | format((flavor_capacity['rtx2080ti-A-1gpu.14vcpu.28g'] | default(0)) - (rtx_a_vms | length)) }} │    ║
          ║  │ rtx2080ti-1gpu.14vcpu.28g         │ {{ '%9d' | format(flavor_capacity['rtx2080ti-1gpu.14vcpu.28g'] | default(0)) }} │ {{ '%9d' | format(rtx_vms | length) }} │ {{ '%9d' | format((flavor_capacity['rtx2080ti-1gpu.14vcpu.28g'] | default(0)) - (rtx_vms | length)) }} │    ║
          ║  │ v1.14vcpu.28g (non-GPU)           │ {{ '%9d' | format(flavor_capacity['v1.14vcpu.28g'] | default(0)) }} │ {{ '%9d' | format(nogpu_vms | length) }} │ {{ '%9d' | format((flavor_capacity['v1.14vcpu.28g'] | default(0)) - (nogpu_vms | length)) }} │    ║
          ║  └───────────────────────────────────┴───────────┴───────────┴───────────┘    ║
          ║                                                                                ║
          {% if v100_vms | length > 0 %}
          ╠════════════════════════════════════════════════════════════════════════════════╣
          ║                                                                                ║
          ║  V100 ASSIGNMENTS ({{ v100_vms | length }} VMs){{ ' ' * (54 - (v100_vms | length | string | length)) }}║
          ║  ┌──────────────────┬────────────────────────────────────────────────────┐    ║
          ║  │ Config           │ VM Name                                            │    ║
          ║  ├──────────────────┼────────────────────────────────────────────────────┤    ║
          {% for vm in v100_vms %}
          ║  │ {{ '%-16s' | format(vm.behavior) }} │ {{ '%-50s' | format(vm.name) }} │    ║
          {% endfor %}
          ║  └──────────────────┴────────────────────────────────────────────────────┘    ║
          ║                                                                                ║
          {% endif %}
          {% if rtx_a_vms | length > 0 %}
          ╠════════════════════════════════════════════════════════════════════════════════╣
          ║                                                                                ║
          ║  RTX 2080 TI A ASSIGNMENTS ({{ rtx_a_vms | length }} VMs) - Hardware comparison{{ ' ' * (26 - (rtx_a_vms | length | string | length)) }}║
          ║  ┌──────────────────┬────────────────────────────────────────────────────┐    ║
          ║  │ Config           │ VM Name                                            │    ║
          ║  ├──────────────────┼────────────────────────────────────────────────────┤    ║
          {% for vm in rtx_a_vms %}
          ║  │ {{ '%-16s' | format(vm.behavior) }} │ {{ '%-50s' | format(vm.name) }} │    ║
          {% endfor %}
          ║  └──────────────────┴────────────────────────────────────────────────────┘    ║
          ║                                                                                ║
          {% endif %}
          {% if rtx_vms | length > 0 %}
          ╠════════════════════════════════════════════════════════════════════════════════╣
          ║                                                                                ║
          ║  RTX 2080 TI ASSIGNMENTS ({{ rtx_vms | length }} VMs){{ ' ' * (51 - (rtx_vms | length | string | length)) }}║
          ║  ┌──────────────────┬────────────────────────────────────────────────────┐    ║
          ║  │ Config           │ VM Name                                            │    ║
          ║  ├──────────────────┼────────────────────────────────────────────────────┤    ║
          {% for vm in rtx_vms %}
          ║  │ {{ '%-16s' | format(vm.behavior) }} │ {{ '%-50s' | format(vm.name) }} │    ║
          {% endfor %}
          ║  └──────────────────┴────────────────────────────────────────────────────┘    ║
          ║                                                                                ║
          {% endif %}
          {% if nogpu_vms | length > 0 %}
          ╠════════════════════════════════════════════════════════════════════════════════╣
          ║                                                                                ║
          ║  NON-GPU ASSIGNMENTS ({{ nogpu_vms | length }} VMs){{ ' ' * (51 - (nogpu_vms | length | string | length)) }}║
          ║  ┌──────────────────┬────────────────────────────────────────────────────┐    ║
          ║  │ Config           │ VM Name                                            │    ║
          ║  ├──────────────────┼────────────────────────────────────────────────────┤    ║
          {% for vm in nogpu_vms %}
          ║  │ {{ '%-16s' | format(vm.behavior) }} │ {{ '%-50s' | format(vm.name) }} │    ║
          {% endfor %}
          ║  └──────────────────┴────────────────────────────────────────────────────┘    ║
          ║                                                                                ║
          {% endif %}
          ╠════════════════════════════════════════════════════════════════════════════════╣
          ║  TOTAL: {{ inventory_entries | length }} VMs  │  V100: {{ v100_vms | length }}  │  RTX A: {{ rtx_a_vms | length }}  │  RTX: {{ rtx_vms | length }}  │  Non-GPU: {{ nogpu_vms | length }}{{ ' ' * (16 - (inventory_entries | length | string | length) - (v100_vms | length | string | length) - (rtx_a_vms | length | string | length) - (rtx_vms | length | string | length) - (nogpu_vms | length | string | length)) }}║
          ╚════════════════════════════════════════════════════════════════════════════════╝

    - name: Generate inventory file on control node
      delegate_to: localhost
      copy:
        content: |
          # Auto-generated inventory for {{ deployment_name }}
          # Generated: {{ lookup('pipe', 'date -Iseconds') }}
          # Access: Via ProxyJump through {{ jump_host }}

          [sup_hosts]
          {% for entry in inventory_entries %}
          {{ entry.name }} ansible_host={{ entry.ip }} sup_behavior={{ entry.behavior }} sup_flavor={{ entry.flavor }}
          {% endfor %}

          [sup_hosts:vars]
          ansible_user=ubuntu
          ansible_python_interpreter=/usr/bin/python3
          ansible_ssh_common_args=-F {{ ssh_config_file }} -o ProxyJump={{ jump_host }} -o StrictHostKeyChecking=no
        dest: "{{ inventory_file }}"

    - name: Display inventory file location
      pause:
        seconds: 0
        prompt: "Inventory written to: {{ inventory_file }}"

    - name: Test SSH connectivity to VMs (via axes)
      delegate_to: localhost
      shell: |
        ssh -F {{ ssh_config_file }} -o ProxyJump={{ jump_host }} -o StrictHostKeyChecking=no -o ConnectTimeout=30 ubuntu@{{ item.ip }} 'echo SSH OK'
      loop: "{{ inventory_entries }}"
      loop_control:
        label: "{{ item.name }} ({{ item.ip }})"
      register: ssh_test
      retries: 10
      delay: 30
      until: ssh_test.rc == 0

    - name: Write SSH config snippet to file
      delegate_to: localhost
      copy:
        content: |
          ############# SUP VMs - {{ deployment_name }} #############
          # Add this to your ~/.ssh/config
          # Requires ProxyJump through axes

          Host sup-*
              User ubuntu
              PreferredAuthentications publickey
              IdentityFile ~/.ssh/id_rsa
              ProxyJump axes
              StrictHostKeyChecking no
              ServerAliveInterval 120

          {% for entry in inventory_entries %}
          Host {{ entry.name }}
              HostName {{ entry.ip }}

          {% endfor %}
          #############################################
        dest: "{{ deployment_dir }}/ssh_config_snippet.txt"

    - name: Display SSH config location
      pause:
        seconds: 0
        prompt: "SSH config saved to: {{ deployment_dir }}/ssh_config_snippet.txt"

    - name: Print SSH config (copy-pasteable)
      delegate_to: localhost
      command: cat "{{ deployment_dir }}/ssh_config_snippet.txt"
      register: ssh_out
      changed_when: false

    - name: SSH Config Output
      pause:
        seconds: 1
        prompt: |

          ═══════════════════════════════════════════════════════════════
            SSH CONFIG - Copy and paste into ~/.ssh/config
          ═══════════════════════════════════════════════════════════════
          {{ ssh_out.stdout }}
          ═══════════════════════════════════════════════════════════════
            Saved to: {{ deployment_dir }}/ssh_config_snippet.txt
          ═══════════════════════════════════════════════════════════════