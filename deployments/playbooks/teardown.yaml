---
# Ansible Playbook: teardown.yaml (Shared)
# Destroy all SUP VMs and their volumes
#
# Usage:
#   ansible-playbook -i ../exp-1/hosts.ini teardown.yaml -e deployment_dir=../exp-1

- name: Teardown SUP VMs
  hosts: openstack_controller
  gather_facts: false

  vars:
    # Default paths (can be overridden via -e)
    deployment_dir: "{{ playbook_dir }}"
    config_file: "{{ deployment_dir }}/config.yaml"

    os_rc_file: "~/vxn3kr-bot-rc"

  pre_tasks:
    - name: Load deployment configuration
      include_vars:
        file: "{{ config_file }}"

    - name: Set deployment-scoped prefix
      set_fact:
        deployment_id: "{{ deployment_id | default(deployment_name | regex_replace('-', '')) }}"

    - name: Set VM prefix
      set_fact:
        vm_prefix: "sup-{{ deployment_id }}-"

    - name: Display deployment info
      pause:
        seconds: 0
        prompt: "Tearing down deployment: {{ deployment_name }} (prefix: {{ vm_prefix }})"

  tasks:
    - name: Get list of SUP servers
      shell: |
        source {{ os_rc_file }}
        openstack server list -f value -c ID -c Name | grep "{{ vm_prefix }}" || true
      args:
        executable: /bin/bash
      register: server_list

    - name: Display servers to be deleted
      pause:
        seconds: 0
        prompt: |
          Found servers to delete:
          {{ server_list.stdout_lines | default(['(none)']) | join('\n') }}

    - name: Get volume IDs attached to SUP servers
      shell: |
        source {{ os_rc_file }}
        for server in $(openstack server list -f value -c Name | grep "{{ vm_prefix }}"); do
          openstack server show "$server" -f json | jq -r '.volumes_attached[]?.id' 2>/dev/null || true
        done
      args:
        executable: /bin/bash
      register: volume_ids
      when: server_list.stdout | length > 0

    - name: Delete SUP servers (parallel)
      shell: |
        source {{ os_rc_file }}
        SERVER_ID="{{ item.split()[0] }}"
        openstack server delete "$SERVER_ID"
      args:
        executable: /bin/bash
      loop: "{{ server_list.stdout_lines }}"
      loop_control:
        label: "{{ item.split()[1] | default(item) }}"
      when: server_list.stdout | length > 0
      ignore_errors: yes
      async: 300
      poll: 0

    - name: Wait for servers to be deleted
      shell: |
        source {{ os_rc_file }}
        SERVER_ID="{{ item.split()[0] }}"
        if ! openstack server show "$SERVER_ID" &>/dev/null; then
          echo "DELETED"
          exit 0
        else
          echo "WAITING"
          exit 1
        fi
      args:
        executable: /bin/bash
      loop: "{{ server_list.stdout_lines }}"
      loop_control:
        label: "{{ item.split()[1] | default(item) }}"
      register: delete_check
      until: delete_check.rc == 0
      retries: 60
      delay: 3
      throttle: 50
      when: server_list.stdout | length > 0
      ignore_errors: yes

    - name: Delete orphaned SUP volumes
      shell: |
        source {{ os_rc_file }}
        # Delete volumes that match our naming pattern
        for vol in $(openstack volume list -f value -c ID -c Name | grep "{{ vm_prefix }}" | awk '{print $1}'); do
          echo "Deleting volume: $vol"
          openstack volume delete "$vol" || true
        done
        # Also delete any volumes from our deleted servers
        {% for vol_id in (volume_ids.stdout_lines | default([])) %}
        {% if vol_id | trim | length > 0 %}
        openstack volume delete "{{ vol_id }}" 2>/dev/null || true
        {% endif %}
        {% endfor %}
      args:
        executable: /bin/bash
      when: server_list.stdout | length > 0 or (volume_ids is defined and volume_ids.stdout | default('') | length > 0)
      ignore_errors: yes

    - name: Verify cleanup
      shell: |
        source {{ os_rc_file }}
        echo "=== Remaining SUP servers ==="
        openstack server list -f value -c Name | grep "{{ vm_prefix }}" || echo "(none)"
        echo ""
        echo "=== Remaining SUP volumes ==="
        openstack volume list -f value -c Name | grep "{{ vm_prefix }}" || echo "(none)"
      args:
        executable: /bin/bash
      register: cleanup_status

    - name: Display cleanup status
      pause:
        seconds: 0
        prompt: "{{ cleanup_status.stdout }}"

    - name: Remove local inventory file
      delegate_to: localhost
      file:
        path: "{{ (run_dir | default(deployment_dir)) }}/inventory.ini"
        state: absent
      ignore_errors: yes